# Uptime Troubleshooting Guide

این راهنما توضیح می‌دهد چرا ممکن است بات تلگرام شما غیر فعال شود و چگونه می‌توانید آن را پایدار نگه دارید؛ حتی زمانی که سیستم شخصی‌تان خاموش است.

## 1. مشکلات رایج که باعث قطع شدن ربات می‌شوند

1. **سشن تلگرام نامعتبر می‌شود**
   اگر رشته‌ی `SESSION_STRING` منقضی یا لغو شود، Telethon دیگر نمی‌تواند وصل شود و حلقه‌ی اصلی متوقف می‌شود. در کد، راه‌اندازی ربات تنها زمانی انجام می‌شود که رشته معتبر باشد و در غیر این صورت `SignalBot` اجرا را خاتمه می‌دهد.【F:signal_bot.py†L1612-L1618】【F:signal_bot.py†L1713-L1730】

2. **اختلال شبکه و قطع شدن طولانی‌مدت**
   ربات به صورت خودکار چند مرتبه تلاش می‌کند تا اتصال را بعد از بروز خطای شبکه برقرار کند، ولی اگر همه‌ی تلاش‌ها شکست بخورد وارد چرخه‌ی راه‌اندازی مجدد می‌شود.【F:signal_bot.py†L1663-L1711】 اگر خطاهای متوالی رخ دهد و به سقف `max_retries` برسد، ربات متوقف می‌شود تا از تلاش بی‌پایان جلوگیری کند.【F:signal_bot.py†L1704-L1708】

3. **محدودیت‌های پلن رایگان Render**
   اگر از پلن رایگان وب‌سرویس در Render استفاده کنید، سرویس بعد از حدود ۱۵ دقیقه عدم دریافت درخواست HTTP به حالت خواب می‌رود. حتی اگر با UptimeRobot روی مسیر `/health` مانیتور کنید، محدودیت ۷۵۰ ساعت در ماه و زمان‌های راه‌اندازی مجدد خودکار همچنان باعث توقف موقت می‌شوند.【F:render.yaml†L1-L8】

4. **نبود نظارت داخلی**  
   اگر Thread ربات در سرور شما کرش کند و برنامه‌ی دیگری برای راه‌اندازی مجدد وجود نداشته باشد، سرویس تا زمان مداخله‌ی دستی متوقف می‌ماند.

## 2. راهکار پیشنهادی بدون هزینه برای اجرای ۲۴/۷

در حال حاضر بهترین راه‌حل رایگان این است که همین پروژه را روی پلن Free وب‌سرویس Render اجرا کنید و با UptimeRobot جلوی Sleep شدن را بگیرید. محدودیت ۷۵۰ ساعت ماهانه Render معادل ۳۱ روز است، بنابراین اگر سرویس همیشه روشن بماند همچنان در محدوده‌ی پلن رایگان خواهید بود.

1. **دیپلوی رایگان روی Render**
   1. سرویس را با فایل `render.yaml` حاضر بسازید تا `healthCheckPath: /health` فعال شود.【F:render.yaml†L1-L12】
   2. پس از دیپلوی، آدرس پابلیک (`https://example.onrender.com`) را یادداشت کنید.
   3. متغیرهای محیطی اصلی (`API_ID`، `API_HASH`، `SESSION_STRING`، `SOURCES`، `DESTS` و `SESSION_SECRET`) را تنظیم کنید. بعد از این آپدیت می‌توانید از داشبورد بدون رمز استفاده کنید و تنظیمات را نهایی نمایید.【F:README.md†L69-L112】【F:README.md†L114-L126】

2. **بیدار نگه داشتن سرویس با UptimeRobot**
   1. در UptimeRobot یک HTTP monitor بسازید و URL را روی مسیر سلامت `/health` تنظیم کنید (مثلاً `https://example.onrender.com/health`).
   2. دوره‌ی چک را روی 5 دقیقه بگذارید؛ این بازه هم Render را بیدار نگه می‌دارد و هم در سهمیه‌ی رایگان UptimeRobot می‌گنجد.
   3. در صورت دریافت هشدار، ابتدا لاگ‌های Render را بررسی کنید و اگر نیاز بود سرویس را دستی ری‌استارت کنید.

3. **راه‌اندازی مجدد خودکار در صورت Crash**
   - Render با استفاده از Health Check تعریف‌شده، اگر پاسخ 200 دریافت نکند سرویس را خودکار ری‌استارت می‌کند. برای زمان‌هایی که اپلیکیشن به خطاهای داخلی می‌رسد این قابلیت حکم یک Supervisor رایگان را دارد.【F:app.py†L430-L448】

4. **آلترناتیوهای رایگان دیگر**
   - *Railway* و *Fly.io* نیز اعتبار رایگان ماهانه ارائه می‌دهند که برای یک کانتینر سبک کافی است؛ اگرچه ممکن است نیاز به کارت بانکی داشته باشند. راه‌اندازی روی این پلتفرم‌ها مشابه Render است و می‌توانید از همان دستور Gunicorn استفاده کنید.

3. **بازبینی دوره‌ای Session**
   هر از چند وقت یک‌بار با اسکریپت معرفی‌شده در README یک Session تازه تولید کنید و مطمئن شوید به‌صورت ناگهانی باطل نشده است. در صورت مشاهده‌ی پیام‌های خطای احراز هویت، فورا Session جدید وارد کنید.

4. **فعال کردن لاگ‌گیری و بررسی آن**  
   لاگ‌های سطح INFO و WARNING در `SignalBot` علت دقیق قطع شدن را نمایش می‌دهند (مثل خطاهای مجوز یا عدم دسترسی به کانال). همین لاگ‌ها به شما کمک می‌کند منبع مشکل را قبل از توقف کامل شناسایی کنید.【F:signal_bot.py†L1521-L1593】

## 3. چک‌لیست پایداری بلندمدت

- [ ] متغیرهای محیطی `API_ID`، `API_HASH`، `SESSION_STRING`، `SOURCES` و `DESTS` به‌درستی تنظیم شده باشند.
- [ ] از هاست ابری همیشه روشن یا پلن پولی استفاده کنید.
- [ ] برای مانیتورینگ، هم UptimeRobot و هم مکانیزم خودکار (Systemd یا قابلیت Health Check هاست) فعال باشد.
- [ ] لاگ‌ها را حداقل هفتگی مرور کنید تا خطاهای احتمالی را پیش از توقف شناسایی کنید.
- [ ] به‌صورت ماهانه Session جدید بسازید یا Session فعلی را تست کنید.

با رعایت این موارد، ربات شما حتی در زمانی که سیستم شخصی‌تان خاموش است هم پایدار باقی می‌ماند و تنها در صورت بروز خطاهای غیرقابل بازیابی نیاز به مداخله‌ی دستی خواهید داشت.
