<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trade Signal Bot Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;       /* slate-900 */
      --panel: #111827;    /* gray-900 */
      --muted: #6b7280;    /* gray-500 */
      --text: #e5e7eb;     /* gray-200 */
      --accent: #22c55e;   /* green-500 */
      --warn: #f59e0b;     /* amber-500 */
      --danger: #ef4444;   /* red-500 */
      --link: #60a5fa;     /* blue-400 */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{font-size:26px;margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns: 2fr 1fr}}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:16px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input, textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid #1f2937;border-radius:8px;padding:10px 12px}
    textarea{min-height:72px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-save{background:var(--link);color:#000}
    .btn-start{background:var(--accent);color:#000}
    .btn-stop{background:var(--danger);color:#fff}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    code{background:#0b1220;border:1px solid #1f2937;border-radius:6px;padding:2px 6px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px}
    .ok{background:#052e1a;color:#86efac;border:1px solid #14532d}
    .no{background:#3f1d1d;color:#fecaca;border:1px solid #7f1d1d}
    .warn{background:#3a2505;color:#fde68a;border:1px solid #92400e}
    .stack{display:flex;flex-direction:column;gap:10px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Trade Signal Bot</h1>
    <div class="grid">
      <!-- Config Panel -->
      <div class="card">
        <form action="/save" method="post" class="stack">
          <div class="row" style="gap:16px">
            <div style="flex:1;min-width:180px">
              <label for="api_id">API ID</label>
              <input id="api_id" name="api_id" type="text" inputmode="numeric" value="{{ cfg.api_id or '' }}" placeholder="e.g. 123456" />
            </div>
            <div style="flex:2;min-width:220px">
              <label for="api_hash">API HASH</label>
              <input id="api_hash" name="api_hash" type="text" value="{{ cfg.api_hash or '' }}" placeholder="e.g. 0123abcd..." />
            </div>
            <div style="flex:1;min-width:220px">
              <label for="session_name">Session name</label>
              <input id="session_name" name="session_name" type="text" value="{{ cfg.session_name or 'signal_bot' }}" />
            </div>
          </div>

          <label for="from_channels">Source channels (SOURCES)</label>
          <input id="from_channels" name="from_channels" type="text" value="{{ cfg.from_channels or '' }}" placeholder='@src1,-1001234567,@src2  or  ["@src1",-1001234567]' />
          <div class="hint">Accepts <code>JSON array</code> یا <code>comma-separated</code>. مثال: <code>@src1,-1001234567,@src2</code> یا <code>["@src1", -1001234567]</code>.</div>

          <label for="to_channel">Destination channels (DESTS)</label>
          <input id="to_channel" name="to_channel" type="text" value="{{ cfg.to_channel or '' }}" placeholder='@dstA,@dstB,-100999888777 or ["@dstA","@dstB",-100999888777]' />
          <div class="hint">می‌توانید چند مقصد بدهید. فرمت‌ها همانند SOURCES.</div>

          <div class="row" style="margin-top:8px">
            <button class="btn btn-save" type="submit">Save configuration</button>
            <form action="/start_bot" method="post">
              <button class="btn btn-start" type="submit">Start bot</button>
            </form>
            <form action="/stop_bot" method="post">
              <button class="btn btn-stop" type="submit">Stop bot</button>
            </form>
          </div>
        </form>
      </div>

      <!-- Status Panel -->
      <div class="card">
        <div class="stack">
          <div id="statusBadge" class="badge warn">
            <strong>Status:</strong> <span id="statusText">Checking…</span>
          </div>
          <div class="small muted">
            • این داشبورد با کلاس جدید <code>SignalBot</code> کار می‌کند که تنظیمات را از متغیرهای محیطی می‌خوانَد.<br />
            • دقت کنید که فهرست کانال‌ها می‌تواند <code>JSON</code> یا <code>comma-separated</code> باشد. در هنگام اجرا به صورت JSON در متغیرهای محیطی ذخیره می‌شود.
          </div>
          <div>
            <div class="muted small">Env preview</div>
            <pre class="small" id="envPreview" style="background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:10px;overflow:auto;max-height:180px"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function refreshStatus(){
      try{
        const r = await fetch('/status', {headers:{'accept':'application/json'}});
        const j = await r.json();
        const badge = document.getElementById('statusBadge');
        const txt = document.getElementById('statusText');
        if(j.running){
          badge.className = 'badge ok';
          txt.textContent = 'Running';
        }else{
          badge.className = 'badge no';
          txt.textContent = 'Stopped';
        }
      }catch(e){
        const badge = document.getElementById('statusBadge');
        const txt = document.getElementById('statusText');
        badge.className = 'badge warn';
        txt.textContent = 'Unknown';
      }
    }

    // Tiny helper to preview what will be put into ENV as JSON arrays
    function parseList(raw){
      if(!raw) return [];
      raw = raw.trim();
      if(!raw) return [];
      try{
        const v = JSON.parse(raw);
        if(Array.isArray(v)) return v.map(x=>x);
      }catch(e){/* fallthrough */}
      return raw.split(',').map(s=>s.trim()).filter(Boolean);
    }
    function renderPreview(){
      const src = document.getElementById('from_channels').value;
      const dst = document.getElementById('to_channel').value;
      const preview = {
        SOURCES: parseList(src),
        DESTS: parseList(dst)
      };
      document.getElementById('envPreview').textContent = JSON.stringify(preview, null, 2);
    }
    document.getElementById('from_channels').addEventListener('input', renderPreview);
    document.getElementById('to_channel').addEventListener('input', renderPreview);

    refreshStatus();
    renderPreview();
    setInterval(refreshStatus, 4000);
  </script>
</body>
</html>
